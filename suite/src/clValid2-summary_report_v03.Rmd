---
title: "`r params$rmd_title`"
author: "Universidad de Deusto (carlos.quesada@deusto.es)"
date: "`r format(Sys.time())`"
output:
  html_document:
  toc: true
toc_depth: 1
theme: united
params:
  rmd_title: "Cluster Report"
  hmp_dir: ""
  hmm_dir: ""
  nofile_path: "no-file.png"
  ff: ""
  dd: ""
  mm: ""
  cc: ""
---

<style type="text/css">
  .main-container {
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
  }
</style>

<hr>
  
#### List of abbreviations
  
##### Sets of features 
* __sAggrDRM__: seasonal aggregates v2.0 (day-referenced mean)
* __sAggrP6__: seasonal aggregates v3.0 (6-period time division)

##### Datasets
* __goi__: GoiEner (including Megara and La Corriente) [ES]
* __lcl__: Low Carbon London [GB]
* __iss__: Irish Social Science Data Archive (ISSDA) [IE]
* __por__: Elergone Energia [PT]
* __nee__: Northwest Energy Efficiency Alliance (NEEA) [US]
* __Nds__: N datasets put together

##### Clustering methods
* __som__: self-organizing maps

<hr>


```{r, include=FALSE}
# Path to hmp graphs
hmp_path <- params$hmp_dir
# Path to hmm values
hmm_path <- params$hmm_dir
# No file by DEFAULT
no.file_path  <- params$nofile_path
no_file <- paste0("![](", no.file_path, ")")
# Block of cards ("bb" is an integer indicating the desired number of blocks)
block_of_cards <- function(txt_list, bb){
  o <- ""
  for (ii in 1:bb) {
    o <- paste0(o,
'<tr>
<td width="16.66%">', txt_list$img[6*bb-5], '</td>
<td width="16.66%">', txt_list$img[6*bb-4], '</td>
<td width="16.66%">', txt_list$img[6*bb-3], '</td>
<td width="16.66%">', txt_list$img[6*bb-2], '</td>
<td width="16.66%">', txt_list$img[6*bb-1], '</td>
<td width="16.66%">', txt_list$img[6*bb], '</td>
</tr>
<tr>
<td><center><small>', txt_list$cap[6*bb-5], '</small></center></td>
<td><center><small>', txt_list$cap[6*bb-4], '</small></center></td>
<td><center><small>', txt_list$cap[6*bb-3], '</small></center></td>
<td><center><small>', txt_list$cap[6*bb-2], '</small></center></td>
<td><center><small>', txt_list$cap[6*bb-1], '</small></center></td>
<td><center><small>', txt_list$cap[6*bb], '</small></center></td>
</tr>
'
    )
  }
}
# Table of cards
table_of_cards <- function(txt_list) {
  o <- paste0(
'<table border="0">
',
block_of_cards(txt_list, 20),
'</table>\n\n
'
  )
  return(o)
}
```

```{r, echo=FALSE, results='asis', message=FALSE}
# Features loop
ff_loop <- params$ff
# Dataset loop
key     <- unique(sapply(1:length(params$dd),
                           function(x) params$dd[[x]]$key))
len_key <- length(key)
dd_name <- ifelse(len_key == 1, key, paste0(len_key, "ds"))
dd_loop <- dd_name
# Methods loop
mm_loop <- params$mm
# FEATURE LOOP
for (ff in ff_loop) {
  # DATASET LOOP
  for (dd in dd_loop) {
    # METHOD LOOP
    for (mm in mm_loop) {
      cat(paste0("## ", ff, " > ", dd, " > ", mm, "\n\n"))
      # Initialization of txt_list
      txt_list <- list(img = rep("", 42), cap = rep("", 42))
      # CLUSTER LOOP
      cc_loop <- 1:params$cc
      
      for (cc in cc_loop) {
        # Get index
        cc_idx <- cc #(cc - 1) %% 12 + 1
        # Path to file
        card_path <- paste0(hmp_path, "hmp_", ff, "_", dd, "_", mm, "_",
                            max(cc_loop), "cl_i-", cc, ".png")
        # Path for loading variable "idx"
        idx_path <- paste0(hmm_path, "hmm_", ff, "_", dd, "_", mm, "_",
                            max(cc_loop), "cl_i-", cc, ".RData")
        # This loads varible "idx"
        if (file.exists(idx_path)) {
          load(idx_path)  
          sum_idx <- sum(idx)
          pct_idx <- round(100*sum(idx)/length(idx),1)
        } else {
          sum_idx <- "?"
          pct_idx <- "?"
        }
        
        # Complete txt_list (MEAN)
        if (file.exists(card_path)) {
          txt_list$img[cc] <- paste0("![](", card_path, ")")
        } else {
          txt_list$img[cc] <- no_file
        }
        txt_list$cap[cc] <- paste0(
          ff, " > ", 
          dd, " > ", 
          mm, " > ",
          "Î¼ > #", cc, "\n\n",
          sum_idx, " TS (",
          pct_idx, "%)\n\n"
        )
        
        # Print HTML table
        if (cc_idx == max(cc_loop)) {
          cat(table_of_cards(txt_list))
        }
      }
    }
  }
}
```